name: Build Cheat Engine

# ──────────────────────────────────────────────────────────────
# 1. Triggers – runs on push, tag, or manual
# ──────────────────────────────────────────────────────────────
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Source version"
        required: true
        default: bleeding-edge
        type: choice
        options:
          - stable-7.5
          - bleeding-edge
      build_mode:
        description: "What to build"
        required: true
        default: main-only
        type: choice
        options:
          - main-only
          - all-components
  push:
    branches: [ master, develop ]
    tags: [ 'v*' ]

# ──────────────────────────────────────────────────────────────
# 2. Dynamic ref (stable or bleeding-edge)
# ──────────────────────────────────────────────────────────────
env:
  REF_TO_BUILD: >-
    ${{ 
      github.event_name == 'push' && 
      (startsWith(github.ref, 'refs/tags/') && github.ref_name || 'master') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.version == 'stable-7.5' && '7.5' || 'master')) ||
      'master'
    }}

# ──────────────────────────────────────────────────────────────
# 3. JOBS
# ──────────────────────────────────────────────────────────────
jobs:
  # =========================================================
  # WINDOWS BUILD
  # =========================================================
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Cheat Engine
        uses: actions/checkout@v4
        with:
          repository: cheat-engine/cheat-engine
          ref: ${{ env.REF_TO_BUILD }}
          submodules: recursive

      - name: Cache Lazarus
        id: cache-win
        uses: actions/cache@v4
        with:
          path: |
            C:\lazarus
            **/*.o
            **/*.ppu
            **/*.compiled
          key: lazarus-2.2.2-Windows-${{ hashFiles('Cheat Engine/cheatengine.lpi') }}
          restore-keys: lazarus-2.2.2-Windows-

      - name: Install Lazarus 2.2.2
        if: steps.cache-win.outputs.cache-hit != 'true'
        uses: gcarreno/setup-lazarus@v3.2.15
        with:
          lazarus-version: "2.2.2"

      # ---------------------------------------------------------
