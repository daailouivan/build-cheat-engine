name: Build Cheat Engine

# ──────────────────────────────────────────────────────────────
# 1. Triggers + UI selectors
# ──────────────────────────────────────────────────────────────
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Source version"
        required: true
        default: bleeding-edge
        type: choice
        options:
          - stable-7.5
          - bleeding-edge
      build_mode:
        description: "What to build"
        required: true
        default: main-only
        type: choice
        options:
          - main-only
          - all-components
  push:
    branches: [ master, develop ]
    tags: [ 'v*' ]

# ──────────────────────────────────────────────────────────────
# 2. Dynamic ref selection
# ──────────────────────────────────────────────────────────────
env:
  REF_TO_BUILD: ${{ 
        github.event_name == 'push' && 
        (startsWith(github.ref, 'refs/tags/') && github.ref_name || 'master') ||
        (github.event_name == 'workflow_dispatch' && 
         (github.event.inputs.version == 'stable-7.5' && '7.5' || 'master')) ||
        'master' }}

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      # ---------------------------------------------------------
      # 1. Checkout source
      # ---------------------------------------------------------
      - name: Checkout Cheat Engine (${{ env.REF_TO_BUILD }})
        uses: actions/checkout@v4
        with:
          repository: cheat-engine/cheat-engine
          ref: ${{ env.REF_TO_BUILD }}
          submodules: recursive

      # ---------------------------------------------------------
      # 2. Cache Lazarus + compiled units
      # ---------------------------------------------------------
      - name: Cache Lazarus & compiled
