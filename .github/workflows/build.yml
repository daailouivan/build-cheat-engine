name: Build Cheat Engine

# -------------------------------------------------
# 1. Triggers – push + manual
# -------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Source version"
        required: true
        default: bleeding-edge
        type: choice
        options:
          - stable-7.5
          - bleeding-edge
      build_mode:
        description: "What to build"
        required: true
        default: main-only
        type: choice
        options:
          - main-only
          - all-components
  push:
    branches: [ master, develop ]
    tags: [ 'v*' ]

# -------------------------------------------------
# 2. Which ref we actually build
# -------------------------------------------------
env:
  REF_TO_BUILD: >-
    ${{ github.event_name == 'push' && 
        (startsWith(github.ref, 'refs/tags/') && github.ref_name || 'master') ||
        (github.event_name == 'workflow_dispatch' && 
         (github.event.inputs.version == 'stable-7.5' && '7.5' || 'master')) ||
        'master' }}

  # master → dev in the artifact name
  ARTIFACT_REF: >-
    ${{ env.REF_TO_BUILD == 'master' && 'dev' || env.REF_TO_BUILD }}

# -------------------------------------------------
# 3. WINDOWS (the only platform that needed the fix)
# -------------------------------------------------
jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      # ---- checkout -------------------------------------------------
      - name: Checkout Cheat Engine
        uses: actions/checkout@v4
        with:
          repository: cheat-engine/cheat-engine
          ref: ${{ env.REF_TO_BUILD }}
          submodules: recursive

      # ---- cache Lazarus --------------------------------------------
      - name: Cache Lazarus
        id: cache
        uses: actions/cache@v4
        with:
          path: C:\lazarus
          key: lazarus-2.2.2-win-${{ hashFiles('**/cheatengine.lpi') }}

      # ---- install Lazarus (only when cache missed) -----------------
      - name: Install Lazarus 2.2.2
        if: steps.cache.outputs.cache-hit != 'true'
        uses: gcarreno/setup-lazarus@v3.2.15
        with:
          lazarus-version: "2.2.2"

      # ---- find lazbuild.exe (works for any folder) -----------------
      - name: Find lazbuild.exe
        id: find
        shell: pwsh
        run: |
          $exe = Get-ChildItem "C:\" -Recurse -Path "lazbuild.exe" -ErrorAction SilentlyContinue |
                 Where-Object { $_.FullName -like "*lazarus*" } |
                 Select-Object -First 1
          if (-not $exe) { Write-Error "lazbuild.exe not found anywhere"; exit 1 }
          Write-Output "LAZBUILD=$($exe.FullName)" >> $env:GITHUB_ENV
          & $exe.FullName --version

      # ---- build ----------------------------------------------------
      - name: Build (main‑only)
        if: ${{ github.event.inputs.build_mode == 'main-only' || !github.event.inputs.build_mode }}
        shell: pwsh
        run: |
          & "$env:LAZBUILD" -B "Cheat Engine/cheatengine.lpi" `
            --cpu=x86_64 `
            --build-mode="Release 64-Bit O4 AVX2"

      # ---- package --------------------------------------------------
      - name: Package & Upload
        shell: pwsh
        run: |
          $mode = "${{ github.event.inputs.build_mode || 'main-only' }}"
          $ref  = "${{ env.ARTIFACT_REF }}"
          $name = "CE-$ref-$mode-win64.7z"
          7z a -t7z -mx=9 $name "Cheat Engine/Cheat Engine/bin/*"
      - uses: actions/upload-artifact@v4
        with:
          name: CE-${{ env.ARTIFACT_REF }}-${{ github.event.inputs.build_mode || 'main-only' }}-win64
          path: CE-*.7z

  # -------------------------------------------------
  # LINUX (unchanged – works out‑of‑the‑box)
  # -------------------------------------------------
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: cheat-engine/cheat-engine
          ref: ${{ env.REF_TO_BUILD }}
          submodules: recursive
      - run: sudo apt-get update && sudo apt-get install -y lazarus p7zip-full
      - name: Build
        if: ${{ github.event.inputs.build_mode == 'main-only' || !github.event.inputs.build_mode }}
        run: lazbuild -B "Cheat Engine/cheatengine.lpi" --cpu=x86_64 --build-mode="Release 64-Bit O4 AVX2"
      - name: Package
        run: |
          mode="${{ github.event.inputs.build_mode || 'main-only' }}"
          ref="${{ env.ARTIFACT_REF }}"
          7z a -t7z -mx=9 "CE-$ref-$mode-linux64.7z" "Cheat Engine/Cheat Engine/bin/"*
      - uses: actions/upload-artifact@v4
        with:
          name: CE-${{ env.ARTIFACT_REF }}-${{ github.event.inputs.build_mode || 'main-only' }}-linux64
          path: CE-*-linux64.7z

  # -------------------------------------------------
  # macOS (unchanged)
  # -------------------------------------------------
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: cheat-engine/cheat-engine
          ref: ${{ env.REF_TO_BUILD }}
          submodules: recursive
      - run: brew update && brew install --cask lazarus && brew install p7zip
      - name: Build
        if: ${{ github.event.inputs.build_mode == 'main-only' || !github.event.inputs.build_mode }}
        run: lazbuild -B "Cheat Engine/cheatengine.lpi" --cpu=x86_64 --build-mode="Release 64-Bit O4 AVX2"
      - name: Package
        run: |
          mode="${{ github.event.inputs.build_mode || 'main-only' }}"
          ref="${{ env.ARTIFACT_REF }}"
          7z a -t7z -mx=9 "CE-$ref-$mode-mac64.7z" "Cheat Engine/Cheat Engine/bin/"*
      - uses: actions/upload-artifact@v4
        with:
          name: CE-${{ env.ARTIFACT_REF }}-${{ github.event.inputs.build_mode || 'main-only' }}-mac64
          path: CE-*-mac64.7z
