name: Build Cheat Engine

# ──────────────────────────────────────────────────────────────
# 1. Triggers – Manual + Push
# ──────────────────────────────────────────────────────────────
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Source version"
        required: true
        default: bleeding-edge
        type: choice
        options:
          - stable-7.5
          - bleeding-edge
      build_mode:
        description: "What to build"
        required: true
        default: main-only
        type: choice
        options:
          - main-only
          - all-components
  push:
    branches: [ master, develop ]
    tags: [ 'v*' ]

# ──────────────────────────────────────────────────────────────
# 2. Dynamic ref selection
# ──────────────────────────────────────────────────────────────
env:
  REF_TO_BUILD: ${{ 
        github.event_name == 'push' && 
        (startsWith(github.ref, 'refs/tags/') && github.ref_name || 'master') ||
        (github.event_name == 'workflow_dispatch' && 
         (github.event.inputs.version == 'stable-7.5' && '7.5' || 'master')) ||
        'master' }}

# ──────────────────────────────────────────────────────────────
# 3. JOBS
# ──────────────────────────────────────────────────────────────
jobs:
  # =========================================================
  # WINDOWS BUILD (Fixed lazbuild path)
  # =========================================================
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Cheat Engine (${{ env.REF_TO_BUILD }})
        uses: actions/checkout@v4
        with:
          repository: cheat-engine/cheat-engine
          ref: ${{ env.REF_TO_BUILD }}
          submodules: recursive

      - name: Cache Lazarus & compiled objects
        id: cache-win
        uses: actions/cache@v4
        with:
          path: |
            C:\lazarus
            **/*.o
            **/*.ppu
            **/*.compiled
          key: lazarus-2.2.2-Windows-${{ hashFiles('Cheat Engine/cheatengine.lpi') }}
          restore-keys: lazarus-2.2.2-Windows-

      - name: Install Lazarus 2.2.2
        if: steps.cache-win.outputs.cache-hit != 'true'
        uses: gcarreno/setup-lazarus@v3.2.15
        with:
          lazarus-version: "2.2.2"

      # ---------------------------------------------------------
      # FIX: Add C:\lazarus to PATH
      # ---------------------------------------------------------
      - name: Add Lazarus to PATH
        run: |
          echo "C:\lazarus" >> $env:GITHUB_PATH

      # ---------------------------------------------------------
      # DEBUG: Confirm lazbuild is found
      # ---------------------------------------------------------
      - name: Verify lazbuild
        shell: pwsh
        run: |
          Get-Command lazbuild
          lazbuild --version

      - name: Log build details
        shell: pwsh
        run: |
          Write-Output "Platform: Windows"
          Write-Output "Version : ${{ env.REF_TO_BUILD }}"
          Write-Output "Mode    : ${{ github.event.inputs.build_mode || 'main-only' }}"

      - name: Build Main Application (x86_64 AVX2)
        if: ${{ github.event.inputs.build_mode == 'main-only' || !github.event.inputs.build_mode }}
        shell: pwsh
        run: |
          C:\lazarus\lazbuild.exe -B "Cheat Engine/cheatengine.lpi" `
                   --cpu=x86_64 `
                   --build-mode="Release 64-Bit O4 AVX2"

      - name: List compiled binaries (debug)
        shell: pwsh
        run: |
          dir "Cheat Engine\Cheat Engine\bin\" -Recurse

      - name: Create Windows archive
        shell: pwsh
        run: |
          $mode = "${{ github.event.inputs.build_mode || 'main-only' }}"
          $ref  = "${{ env.REF_TO_BUILD }}".Replace('/', '-')
          $name = "CE-$ref-$mode-win64.7z"
          7z a -t7z -mx=9 $name "Cheat Engine\Cheat Engine\bin\*"
          Write-Output "Archive: $name"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: CE-${{ env.REF_TO_BUILD }}-${{ github.event.inputs.build_mode || 'main-only' }}-win64
          path: CE-*-win64.7z
          if-no-files-found: error

  # =========================================================
  # LINUX BUILD
  # =========================================================
  build-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Cheat Engine (${{ env.REF_TO_BUILD }})
        uses: actions/checkout@v4
        with:
          repository: cheat-engine/cheat-engine
          ref: ${{ env.REF_TO_BUILD }}
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lazarus p7zip-full

      - name: Cache Lazarus & compiled objects
        id: cache-linux
        uses: actions/cache@v4
        with:
          path: |
            ~/.lazarus
            **/*.o
            **/*.ppu
            **/*.compiled
          key: lazarus-2.2.2-Linux-${{ hashFiles('Cheat Engine/cheatengine.lpi') }}
          restore-keys: lazarus-2.2.2-Linux-

      - name: Log build details
        run: |
          echo "Platform: Linux"
          echo "Version : ${{ env.REF_TO_BUILD }}"
          echo "Mode    : ${{ github.event.inputs.build_mode || 'main-only' }}"

      - name: Build Main Application (x86_64 AVX2)
        if: ${{ github.event.inputs.build_mode == 'main-only' || !github.event.inputs.build_mode }}
        run: |
          lazbuild -B "Cheat Engine/cheatengine.lpi" \
                   --cpu=x86_64 \
                   --build-mode="Release 64-Bit O4 AVX2"

      - name: List compiled binaries (debug)
        run: |
          ls -R "Cheat Engine/Cheat Engine/bin/"

      - name: Create Linux archive
        run: |
          mode="${{ github.event.inputs.build_mode || 'main-only' }}"
          ref="${{ env.REF_TO_BUILD }}"; ref="${ref//\//-}"
          name="CE-$ref-$mode-linux64.7z"
          7z a -t7z -mx=9 "$name" "Cheat Engine/Cheat Engine/bin/"*
          echo "Archive: $name"

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: CE-${{ env.REF_TO_BUILD }}-${{ github.event.inputs.build_mode || 'main-only' }}-linux64
          path: CE-*-linux64.7z
          if-no-files-found: error

  # =========================================================
  # macOS BUILD
  # =========================================================
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Cheat Engine (${{ env.REF_TO_BUILD }})
        uses: actions/checkout@v4
        with:
          repository: cheat-engine/cheat-engine
          ref: ${{ env.REF_TO_BUILD }}
          submodules: recursive

      - name: Install dependencies
        run: |
          brew update
          brew install --cask lazarus
          brew install p7zip

      - name: Cache Lazarus & compiled objects
        id: cache-macos
        uses: actions/cache@v4
        with:
          path: |
            /Users/runner/Library/Lazarus
            **/*.o
            **/*.ppu
            **/*.compiled
          key: lazarus-2.2.2-macOS-${{ hashFiles('Cheat Engine/cheatengine.lpi') }}
          restore-keys: lazarus-2.2.2-macOS-

      - name: Log build details
        run: |
          echo "Platform: macOS"
          echo "Version : ${{ env.REF_TO_BUILD }}"
          echo "Mode    : ${{ github.event.inputs.build_mode || 'main-only' }}"

      - name: Build Main Application (x86_64 AVX2)
        if: ${{ github.event.inputs.build_mode == 'main-only' || !github.event.inputs.build_mode }}
        run: |
          lazbuild -B "Cheat Engine/cheatengine.lpi" \
                   --cpu=x86_64 \
                   --build-mode="Release 64-Bit O4 AVX2"

      - name: List compiled binaries (debug)
        run: |
          ls -R "Cheat Engine/Cheat Engine/bin/"

      - name: Create macOS archive
        run: |
          mode="${{ github.event.inputs.build_mode || 'main-only' }}"
          ref="${{ env.REF_TO_BUILD }}"; ref="${ref//\//-}"
          name="CE-$ref-$mode-mac64.7z"
          7z a -t7z -mx=9 "$name" "Cheat Engine/Cheat Engine/bin/"*
          echo "Archive: $name"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: CE-${{ env.REF_TO_BUILD }}-${{ github.event.inputs.build_mode || 'main-only' }}-mac64
          path: CE-*-mac64.7z
          if-no-files-found: error
